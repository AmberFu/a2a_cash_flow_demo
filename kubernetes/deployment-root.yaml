apiVersion: apps/v1
kind: Deployment
metadata:
  name: root-agent
  namespace: a2a-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: root-agent
  template:
    metadata:
      labels:
        app: root-agent
        version: "v1.0.0-local-mode" # Add a version label to force restart
    spec:
      # 對齊 tfvars：root_agent_sa_name = "ds-a2a-root-agent-sa"
      serviceAccountName: ds-a2a-root-agent-sa
      containers:
      - name: root-agent-container
        image: 182399696164.dkr.ecr.ap-southeast-1.amazonaws.com/image/a2a_demo_root_agent:20251015092919
        imagePullPolicy: Always
        ports:
        - containerPort: 50000
        env:
          # --- 遠端 Agent 連線配置 ---
          - name: REMOTE1_URL # Weather Agent (Agent A / 1)
            value: "http://remote-agent-1-service:50001"
          - name: REMOTE2_URL # Train Agent (Agent B / 2)
            value: "http://remote-agent-2-service:50002"
          - name: SUMMARY_URL # Summary Agent (Aggregator)
            value: "http://summary-agent-service:50003"
          - name: ROOT_LLM_PROVIDER
            valueFrom:
              configMapKeyRef:
                name: agent-llm-config
                key: ROOT_LLM_PROVIDER
          - name: ROOT_LLM_MODEL_ID
            valueFrom:
              configMapKeyRef:
                name: agent-llm-config
                key: ROOT_LLM_MODEL_ID
          - name: REMOTE1_MODEL_PROVIDER
            valueFrom:
              configMapKeyRef:
                name: agent-llm-config
                key: REMOTE1_MODEL_PROVIDER
          - name: REMOTE1_MODEL_ID
            valueFrom:
              configMapKeyRef:
                name: agent-llm-config
                key: REMOTE1_MODEL_ID
          - name: REMOTE2_MODEL_PROVIDER
            valueFrom:
              configMapKeyRef:
                name: agent-llm-config
                key: REMOTE2_MODEL_PROVIDER
          - name: REMOTE2_MODEL_ID
            valueFrom:
              configMapKeyRef:
                name: agent-llm-config
                key: REMOTE2_MODEL_ID
          - name: SUMMARY_MODEL_PROVIDER
            valueFrom:
              configMapKeyRef:
                name: agent-llm-config
                key: SUMMARY_MODEL_PROVIDER
          - name: SUMMARY_MODEL_ID
            valueFrom:
              configMapKeyRef:
                name: agent-llm-config
                key: SUMMARY_MODEL_ID

          # --- AWS & Checkpoint 配置 (新增/更新) ---
          - name: AWS_REGION
            value: "ap-southeast-1"

          # 用於 tools.py 發送事件
          - name: EVENT_BUS_NAME 
            value: "a2a-cash-flow-demo-bus" # 您的 Event Bus 名稱
            
          # DDB Tables for LangGraph Checkpoint and Audit
          - name: DDB_A2A_TASKS_TABLE_NAME # 更新變數名稱以匹配 graph.py 中的預期
            value: "ds_demo_a2a_tasks"
          - name: DDB_A2A_AUDIT_TABLE_NAME # 新增：Audit 表格名稱
            value: "ds_demo_a2a_audit"
          
          # Redis Configuration for Short-term Memory (e.g., Session Cache)
          # Redis: d-redis-sg (endpoint: d-redis-sg-iqd4qt.serverless.apse1.cache.amazonaws.com:6379)
          - name: REDIS_HOST
            value: "d-redis-sg-iqd4qt.serverless.apse1.cache.amazonaws.com"
          - name: REDIS_PORT
            value: "6379"

          # --- Workflow Mode ---
          # "eventbridge" (default): Uses AWS EventBridge for async orchestration.
          # "local": Uses direct JSON-RPC calls for synchronous testing.
          - name: A2A_WORKFLOW_MODE
            value: "local"

          # --- JSON-RPC over HTTPS 測試開關 ---
          - name: JSONRPC_ENABLED
            value: "true"
          - name: JSONRPC_BIND
            value: "0.0.0.0"
          - name: JSONRPC_PORT
            value: "50000"
          - name: JSONRPC_BASE_PATH
            value: "/jsonrpc"
          - name: METRICS_ENABLED
            value: "true"
