sequenceDiagram
    participant User
    participant Root Agent
    participant EventBridge
    participant Weather Agent
    participant Train Agent
    participant Summary Agent
    participant HITL as "HITL (Human Reviewer)"

    User->>+Root Agent: 發起請求 (例如：查詢明天去高雄，預算1000元)
    Root Agent->>Root Agent: 建立 Task，儲存初始狀態 (LangGraph)
    
    %% -- 平行分派任務 --
    Root Agent->>+EventBridge: 發送 "Task.GetWeather" 事件
    EventBridge-->>Weather Agent: (via SQS) 路由事件
    deactivate EventBridge

    Root Agent->>+EventBridge: 發送 "Task.GetTrainSchedule" 事件
    EventBridge-->>Train Agent: (via SQS) 路由事件
    deactivate EventBridge
    
    Note right of Root Agent: Graph 進入等待 (interrupt) 狀態

    %% -- 遠端 Agent 處理與回呼 --
    Weather Agent->>Weather Agent: 處理任務 (查詢天氣)
    Weather Agent-->>Root Agent: (via SQS Callback Queue) 回報天氣資訊
    
    Train Agent->>Train Agent: 處理任務 (查詢火車時刻)
    Train Agent-->>Root Agent: (via SQS Callback Queue) 回報火車時刻
    
    %% -- 聚合與 HITL 判斷 --
    Root Agent->>Root Agent: 收到回呼，更新 Graph 狀態
    Note right of Root Agent: LangGraph Router 檢查是否<br/>所有前置任務 (天氣、火車) 都已完成

    alt 資訊不足，需要 HITL
        Root Agent->>HITL: 發出 HITL 請求：補充/確認關鍵資訊
        Note right of Root Agent: Graph 進入等待 (interrupt) 狀態
        HITL-->>Root Agent: 人工回覆（補件/決策）
        Root Agent->>Root Agent: 併入 HITL 回覆並更新狀態
    else 資訊充分，無需 HITL
        Note right of Root Agent: 自動流程繼續
    end
    
    %% -- 繼續分派總結任務 --
    Root Agent->>+EventBridge: 發送 "Task.Summarize" 事件 (附上天氣、火車與可能的 HITL 補充)
    EventBridge-->>Summary Agent: (via SQS) 路由事件
    deactivate EventBridge
    
    Note right of Root Agent: Graph 再次進入等待狀態

    %% -- 最終總結與結束 --
    Summary Agent->>Summary Agent: 處理任務 (根據預算、天氣、交通提出建議)
    Summary Agent-->>Root Agent: (via SQS Callback Queue) 回報最終建議
    
    Root Agent->>Root Agent: 收到最終回呼，更新狀態為 "completed"
    Root Agent-->>User: 回傳最終結果
